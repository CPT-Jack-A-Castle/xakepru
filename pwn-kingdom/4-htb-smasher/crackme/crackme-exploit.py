#!/usr/bin/env python
# -*- coding: utf-8 -*-

# Использование: python crackme-exploit.py

import os

from pwn import *
from paddingoracle import BadPaddingException, PaddingOracle
from Crypto.Cipher import AES

BLOCK_SIZE = AES.block_size


class PadBuster(PaddingOracle):
	def __init__(self, **kwargs):
		self.r = remote('localhost', 1337)
		log.info('Progress:\n\n\n\n')
		super(PadBuster, self).__init__(**kwargs)

	def oracle(self, data, **kwargs):
		os.write(1, '\x1b[3F')  # ANSI escape-последовательность для очистки 3-х последних строк вывода
		print(hexdump(data))
		self.r.recvuntil('Insert ciphertext:')
		self.r.sendline(b64e(data))
		recieved = self.r.recvline()

		if 'Invalid Padding!' in recieved:
			# An HTTP 500 error was returned, likely due to incorrect padding
			raise BadPaddingException


if __name__ == '__main__':
	ciphertext = b64d('irRmWB7oJSMbtBC4QuoB13DC08NI06MbcWEOc94q0OXPbfgRm+l9xHkPQ7r7NdFjo6hSo6togqLYITGGpPsXdg==')
	log.info('Ciphertext length: %s byte(s), %s block(s)' % (len(ciphertext), len(ciphertext) // BLOCK_SIZE))

	padbuster = PadBuster()
	plaintext = padbuster.decrypt(ciphertext, block_size=BLOCK_SIZE, iv='\x00'*16)

	log.success('Cracked: %s' % plaintext)
